# Lab: Exploiting Java deserialization with Apache Commons

**Link**: https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-exploiting-java-deserialization-with-apache-commons

**Solution**:

In the cookie session, you will find a string starts with `ro0A` which always identifies as serialized java object

<p align="center" width="100%">
  <img src="image1.png" width="800" hight="500"/>
</p>

<p align="center" width="100%">
  <img src="image2.png" width="800" hight="500"/>
</p>

We will use tool [Ysoserial](https://github.com/frohoff/ysoserial) tool

To use it like the following which will generate a base64 serialized object which will execute the `CMD Code` you will give

```bash
$ java -jar ysoserial-all.jar CommonsCollections1 <CMD Code> | base64 -w 0
```

In the lab, it need to delete .txt file

```bash
$ java -jar ysoserial-all.jar CommonsCollections1 'rm /home/carlos/morale.txt' | base64 -w 0
```

The above command will generate a base64-encoded text in Linux

In windows, you need to copy the following text and encode it manually

<p align="center" width="100%">
  <img src="image3.png" width="800" hight="500"/>
</p>

We will replace this base64 string with session cookie to see if the code is executed or not

It didnâ€™t work and solved the lab ðŸ˜ž

We will try another payloads of this tool instead of `CommonsCollections1` to see which Java gadget chains works.

There is a lot

<p align="center" width="100%">
  <img src="image4.png" width="800" hight="500"/>
</p>

We can type it manually and see the Output, or just write a bash or python script to automate it.

For time saving, payloads `CommonsCollections4` working fine for this java project

```bash
$ java -jar ysoserial-all.jar CommonsCollections4 'rm /home/carlos/morale.txt' | base64 -w 0
```

This payload has an issue with Java version 16 or 17 +, you need to use java version 8 to 15 (https://forum.portswigger.net/thread/ysoserial-stopped-working-b5a161f42f)
